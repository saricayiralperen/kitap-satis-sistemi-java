<!DOCTYPE html>
<html lang="tr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SipariÅŸi Tamamla - AlperenBooks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
            color: #007bff !important;
        }
        .sepet-count {
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            position: absolute;
            top: -5px;
            right: -5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">ðŸ“š AlperenBooks</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Ana Sayfa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/kitaplar">Kitaplar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/kategori-listesi">Kategoriler</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item position-relative">
                        <a class="nav-link" href="/sepet">
                            <i class="fas fa-shopping-cart"></i> Sepetim
                            <span class="sepet-count" th:text="${#lists.isEmpty(sepetItems) ? 0 : #aggregates.sum(sepetItems.![adet])}">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/favoriler">
                            <i class="fas fa-heart"></i> Favorilerim
                        </a>
                    </li>
                    <!-- KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸsa -->
                    <li class="nav-item" th:if="${session.IsLoggedIn == null or session.IsLoggedIn == false}">
                        <a class="nav-link" th:href="@{/kullanici/login}">
                            <i class="fas fa-sign-in-alt"></i> GiriÅŸ Yap
                        </a>
                    </li>
                    <li class="nav-item" th:if="${session.IsLoggedIn == null or session.IsLoggedIn == false}">
                        <a class="nav-link" th:href="@{/kullanici/register}">
                            <i class="fas fa-user-plus"></i> KayÄ±t Ol
                        </a>
                    </li>
                    <!-- KullanÄ±cÄ± giriÅŸ yapmÄ±ÅŸsa -->
                    <li class="nav-item dropdown" th:if="${session.IsLoggedIn == true}">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> <span th:text="${session.KullaniciAd}">KullanÄ±cÄ±</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" th:href="@{/kullanici/profil}"><i class="fas fa-user"></i> Profilim</a></li>
                            <li><a class="dropdown-item" th:href="@{/siparisler}"><i class="fas fa-shopping-bag"></i> SipariÅŸlerim</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" th:href="@{/kullanici/logout}"><i class="fas fa-sign-out-alt"></i> Ã‡Ä±kÄ±ÅŸ Yap</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 class="mb-4">SipariÅŸi Tamamla</h1>
        
        <form th:action="@{/sepet/siparis-tamamla}" method="post">
            <!-- Teslimat Adresi -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Teslimat Adresi</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="il" class="form-label">Ä°l</label>
                            <select class="form-select" id="il" name="il" required>
                                <option value="">Ä°l SeÃ§iniz</option>
                                <option value="Ä°stanbul">Ä°stanbul</option>
                                <option value="Ankara">Ankara</option>
                                <option value="Ä°zmir">Ä°zmir</option>
                                <option value="Bursa">Bursa</option>
                                <option value="Antalya">Antalya</option>
                                <option value="Adana">Adana</option>
                                <option value="Konya">Konya</option>
                                <option value="Gaziantep">Gaziantep</option>
                                <option value="Kayseri">Kayseri</option>
                                <option value="Mersin">Mersin</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ilce" class="form-label">Ä°lÃ§e</label>
                            <input type="text" class="form-control" id="ilce" name="ilce" placeholder="Ä°lÃ§e" required />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="adres" class="form-label">DetaylÄ± Adres</label>
                        <textarea class="form-control" id="adres" name="adres" rows="3" placeholder="Mahalle, sokak, bina no, daire no vb." required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="postaKodu" class="form-label">Posta Kodu</label>
                            <input type="text" class="form-control" id="postaKodu" name="postaKodu" placeholder="34000" maxlength="5" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="telefon" class="form-label">Telefon</label>
                            <input type="tel" class="form-control" id="telefon" name="telefon" placeholder="0555 123 45 67" required />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ã–deme Bilgileri -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-credit-card"></i> Ã–deme Bilgileri</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="kartSahibi" class="form-label">Kart Sahibinin AdÄ±</label>
                        <input type="text" class="form-control" id="kartSahibi" name="kartSahibi" placeholder="ALPEREN SARICAYIR" required />
                    </div>
                    <div class="mb-3">
                        <label for="kartNumarasi" class="form-label">Kart NumarasÄ±</label>
                        <input type="text" class="form-control" id="kartNumarasi" name="kartNumarasi" placeholder="1234 5678 9012 3456" maxlength="19" required />
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sonKullanma" class="form-label">Son Kullanma Tarihi</label>
                            <input type="text" class="form-control" id="sonKullanma" name="sonKullanma" placeholder="MM/YY" maxlength="5" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cvv" class="form-label">CVV</label>
                            <input type="text" class="form-control" id="cvv" name="cvv" placeholder="123" maxlength="3" required />
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="sozlesme" name="sozlesme" required>
                        <label class="form-check-label" for="sozlesme">
                            <a href="/privacy" target="_blank">KullanÄ±m ÅŸartlarÄ±</a>nÄ± okudum ve kabul ediyorum.
                        </label>
                    </div>
                </div>
            </div>
            
            <h4>Sepet Ã–zeti</h4>
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Kitap</th>
                        <th>Adet</th>
                        <th>Fiyat</th>
                        <th>Toplam</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${sepetItems}">
                        <td th:text="${item.kitapAd}"></td>
                        <td th:text="${item.adet}"></td>
                        <td th:text="${#numbers.formatCurrency(item.fiyat)}"></td>
                        <td th:text="${#numbers.formatCurrency(item.toplamFiyat)}"></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end fw-bold">Genel Toplam:</td>
                        <td class="fw-bold" th:text="${#numbers.formatCurrency(#aggregates.sum(sepetItems.![toplamFiyat]))}"></td>
                    </tr>
                </tfoot>
            </table>
            
            <button type="submit" class="btn btn-success">SipariÅŸi Onayla</button>
            <a href="/sepet" class="btn btn-secondary">Geri</a>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Kart numarasÄ± formatÄ±
        document.getElementById('kartNumarasi').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedValue.length > 19) formattedValue = formattedValue.substr(0, 19);
            e.target.value = formattedValue;
        });

        // Son kullanma tarihi formatÄ±
        document.getElementById('sonKullanma').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        // CVV sadece rakam
        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // Telefon formatÄ±
        document.getElementById('telefon').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 4) {
                    value = value;
                } else if (value.length <= 7) {
                    value = value.substring(0, 4) + ' ' + value.substring(4);
                } else if (value.length <= 9) {
                    value = value.substring(0, 4) + ' ' + value.substring(4, 7) + ' ' + value.substring(7);
                } else {
                    value = value.substring(0, 4) + ' ' + value.substring(4, 7) + ' ' + value.substring(7, 9) + ' ' + value.substring(9, 11);
                }
            }
            e.target.value = value;
        });

        // Posta kodu sadece rakam
        document.getElementById('postaKodu').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>