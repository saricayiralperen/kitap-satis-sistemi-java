<!DOCTYPE html>
<html lang="tr" xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/layout :: layout(~{::title}, ~{::main})}">
<head>
    <title th:text="'Sipariş #' + ${siparis.id} + ' - Düzenle'">Sipariş Düzenle</title>
</head>
<body>
    <main>
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">
                <i class="fas fa-edit"></i> 
                Sipariş Düzenle
                <small class="text-muted" th:text="'#' + ${siparis.id}">#1</small>
            </h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <a th:href="@{/admin/siparisler}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Geri Dön
                    </a>
                    <a th:href="@{/admin/siparisler/{id}(id=${siparis.id})}" class="btn btn-outline-info">
                        <i class="fas fa-eye"></i> Görüntüle
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Success/Error Messages -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i>
            <span th:text="${successMessage}">İşlem başarılı</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span th:text="${errorMessage}">Hata oluştu</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <div class="row">
            <!-- Form -->
            <div class="col-lg-8">
                <form th:action="@{/admin/siparisler/{id}(id=${siparis.id})}" 
                      th:object="${siparis}" method="post" novalidate>
                    
                    <input type="hidden" name="_method" value="put">
                    <input type="hidden" th:field="*{id}">
                    
                    <!-- Order Status -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-info-circle"></i> Sipariş Durumu
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="durum" class="form-label">
                                        <i class="fas fa-flag text-primary"></i> Sipariş Durumu *
                                    </label>
                                    <select class="form-select" 
                                            th:class="${#fields.hasErrors('durum')} ? 'form-select is-invalid' : 'form-select'"
                                            id="durum" 
                                            th:field="*{durum}">
                                        <option value="BEKLEMEDE">Beklemede</option>
                                        <option value="ONAYLANDI">Onaylandı</option>
                                        <option value="KARGOLANDI">Kargolandı</option>
                                        <option value="TESLIM_EDILDI">Teslim Edildi</option>
                                        <option value="IPTAL_EDILDI">İptal Edildi</option>
                                    </select>
                                    <div th:if="${#fields.hasErrors('durum')}" class="invalid-feedback">
                                        <span th:errors="*{durum}">Durum hatası</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="odemeDurumu" class="form-label">
                                        <i class="fas fa-credit-card text-success"></i> Ödeme Durumu *
                                    </label>
                                    <select class="form-select" 
                                            th:class="${#fields.hasErrors('odemeDurumu')} ? 'form-select is-invalid' : 'form-select'"
                                            id="odemeDurumu" 
                                            th:field="*{odemeDurumu}">
                                        <option value="BEKLEMEDE">Beklemede</option>
                                        <option value="ODENDI">Ödendi</option>
                                        <option value="IADE_EDILDI">İade Edildi</option>
                                    </select>
                                    <div th:if="${#fields.hasErrors('odemeDurumu')}" class="invalid-feedback">
                                        <span th:errors="*{odemeDurumu}">Ödeme durumu hatası</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="odemeYontemi" class="form-label">
                                        <i class="fas fa-money-bill text-info"></i> Ödeme Yöntemi
                                    </label>
                                    <select class="form-select" 
                                            th:class="${#fields.hasErrors('odemeYontemi')} ? 'form-select is-invalid' : 'form-select'"
                                            id="odemeYontemi" 
                                            th:field="*{odemeYontemi}">
                                        <option value="">Seçiniz</option>
                                        <option value="Kredi Kartı">Kredi Kartı</option>
                                        <option value="Banka Kartı">Banka Kartı</option>
                                        <option value="Havale/EFT">Havale/EFT</option>
                                        <option value="Kapıda Ödeme">Kapıda Ödeme</option>
                                        <option value="Diğer">Diğer</option>
                                    </select>
                                    <div th:if="${#fields.hasErrors('odemeYontemi')}" class="invalid-feedback">
                                        <span th:errors="*{odemeYontemi}">Ödeme yöntemi hatası</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="kargoFirması" class="form-label">
                                        <i class="fas fa-truck text-warning"></i> Kargo Firması
                                    </label>
                                    <select class="form-select" 
                                            th:class="${#fields.hasErrors('kargoFirması')} ? 'form-select is-invalid' : 'form-select'"
                                            id="kargoFirması" 
                                            th:field="*{kargoFirması}">
                                        <option value="">Seçiniz</option>
                                        <option value="MNG Kargo">MNG Kargo</option>
                                        <option value="Yurtiçi Kargo">Yurtiçi Kargo</option>
                                        <option value="Aras Kargo">Aras Kargo</option>
                                        <option value="PTT Kargo">PTT Kargo</option>
                                        <option value="UPS">UPS</option>
                                        <option value="DHL">DHL</option>
                                        <option value="Diğer">Diğer</option>
                                    </select>
                                    <div th:if="${#fields.hasErrors('kargoFirması')}" class="invalid-feedback">
                                        <span th:errors="*{kargoFirması}">Kargo firması hatası</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="kargoTakipNo" class="form-label">
                                        <i class="fas fa-barcode text-secondary"></i> Kargo Takip No
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           th:class="${#fields.hasErrors('kargoTakipNo')} ? 'form-control is-invalid' : 'form-control'"
                                           id="kargoTakipNo" 
                                           th:field="*{kargoTakipNo}" 
                                           placeholder="Kargo takip numarasını giriniz">
                                    <div th:if="${#fields.hasErrors('kargoTakipNo')}" class="invalid-feedback">
                                        <span th:errors="*{kargoTakipNo}">Kargo takip no hatası</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="tahminiTeslimTarihi" class="form-label">
                                        <i class="fas fa-calendar text-info"></i> Tahmini Teslim Tarihi
                                    </label>
                                    <input type="date" 
                                           class="form-control" 
                                           th:class="${#fields.hasErrors('tahminiTeslimTarihi')} ? 'form-control is-invalid' : 'form-control'"
                                           id="tahminiTeslimTarihi" 
                                           th:field="*{tahminiTeslimTarihi}">
                                    <div th:if="${#fields.hasErrors('tahminiTeslimTarihi')}" class="invalid-feedback">
                                        <span th:errors="*{tahminiTeslimTarihi}">Tahmini teslim tarihi hatası</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delivery Information -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-map-marker-alt"></i> Teslimat Bilgileri
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="teslimatAdi" class="form-label">
                                        <i class="fas fa-user text-primary"></i> Teslimat Adı
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           th:class="${#fields.hasErrors('teslimatAdi')} ? 'form-control is-invalid' : 'form-control'"
                                           id="teslimatAdi" 
                                           th:field="*{teslimatAdi}" 
                                           placeholder="Teslimat alacak kişinin adı">
                                    <div th:if="${#fields.hasErrors('teslimatAdi')}" class="invalid-feedback">
                                        <span th:errors="*{teslimatAdi}">Teslimat adı hatası</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="teslimatTelefon" class="form-label">
                                        <i class="fas fa-phone text-success"></i> Teslimat Telefon
                                    </label>
                                    <input type="tel" 
                                           class="form-control" 
                                           th:class="${#fields.hasErrors('teslimatTelefon')} ? 'form-control is-invalid' : 'form-control'"
                                           id="teslimatTelefon" 
                                           th:field="*{teslimatTelefon}" 
                                           placeholder="Teslimat telefon numarası">
                                    <div th:if="${#fields.hasErrors('teslimatTelefon')}" class="invalid-feedback">
                                        <span th:errors="*{teslimatTelefon}">Teslimat telefon hatası</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="teslimatEmail" class="form-label">
                                        <i class="fas fa-envelope text-info"></i> Teslimat Email
                                    </label>
                                    <input type="email" 
                                           class="form-control" 
                                           th:class="${#fields.hasErrors('teslimatEmail')} ? 'form-control is-invalid' : 'form-control'"
                                           id="teslimatEmail" 
                                           th:field="*{teslimatEmail}" 
                                           placeholder="Teslimat email adresi">
                                    <div th:if="${#fields.hasErrors('teslimatEmail')}" class="invalid-feedback">
                                        <span th:errors="*{teslimatEmail}">Teslimat email hatası</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="teslimatSehir" class="form-label">
                                        <i class="fas fa-city text-warning"></i> Şehir
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           th:class="${#fields.hasErrors('teslimatSehir')} ? 'form-control is-invalid' : 'form-control'"
                                           id="teslimatSehir" 
                                           th:field="*{teslimatSehir}" 
                                           placeholder="Teslimat şehri">
                                    <div th:if="${#fields.hasErrors('teslimatSehir')}" class="invalid-feedback">
                                        <span th:errors="*{teslimatSehir}">Teslimat şehir hatası</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="teslimatAdres" class="form-label">
                                    <i class="fas fa-map-marker-alt text-danger"></i> Teslimat Adresi
                                </label>
                                <textarea class="form-control" 
                                          th:class="${#fields.hasErrors('teslimatAdres')} ? 'form-control is-invalid' : 'form-control'"
                                          id="teslimatAdres" 
                                          th:field="*{teslimatAdres}" 
                                          rows="3" 
                                          placeholder="Detaylı teslimat adresini giriniz"></textarea>
                                <div th:if="${#fields.hasErrors('teslimatAdres')}" class="invalid-feedback">
                                    <span th:errors="*{teslimatAdres}">Teslimat adres hatası</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Information -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-calculator"></i> Fiyat Bilgileri
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="araToplam" class="form-label">
                                        <i class="fas fa-money-bill text-info"></i> Ara Toplam (₺)
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           th:class="${#fields.hasErrors('araToplam')} ? 'form-control is-invalid' : 'form-control'"
                                           id="araToplam" 
                                           th:field="*{araToplam}" 
                                           placeholder="0.00"
                                           step="0.01"
                                           min="0"
                                           readonly>
                                    <div th:if="${#fields.hasErrors('araToplam')}" class="invalid-feedback">
                                        <span th:errors="*{araToplam}">Ara toplam hatası</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="kargoUcreti" class="form-label">
                                        <i class="fas fa-truck text-warning"></i> Kargo Ücreti (₺)
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           th:class="${#fields.hasErrors('kargoUcreti')} ? 'form-control is-invalid' : 'form-control'"
                                           id="kargoUcreti" 
                                           th:field="*{kargoUcreti}" 
                                           placeholder="0.00"
                                           step="0.01"
                                           min="0"
                                           onchange="calculateTotal()">
                                    <div th:if="${#fields.hasErrors('kargoUcreti')}" class="invalid-feedback">
                                        <span th:errors="*{kargoUcreti}">Kargo ücreti hatası</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="indirimTutari" class="form-label">
                                        <i class="fas fa-percentage text-danger"></i> İndirim Tutarı (₺)
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           th:class="${#fields.hasErrors('indirimTutari')} ? 'form-control is-invalid' : 'form-control'"
                                           id="indirimTutari" 
                                           th:field="*{indirimTutari}" 
                                           placeholder="0.00"
                                           step="0.01"
                                           min="0"
                                           onchange="calculateTotal()">
                                    <div th:if="${#fields.hasErrors('indirimTutari')}" class="invalid-feedback">
                                        <span th:errors="*{indirimTutari}">İndirim tutarı hatası</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="indirimKodu" class="form-label">
                                        <i class="fas fa-tag text-success"></i> İndirim Kodu
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           th:class="${#fields.hasErrors('indirimKodu')} ? 'form-control is-invalid' : 'form-control'"
                                           id="indirimKodu" 
                                           th:field="*{indirimKodu}" 
                                           placeholder="İndirim kodu varsa giriniz">
                                    <div th:if="${#fields.hasErrors('indirimKodu')}" class="invalid-feedback">
                                        <span th:errors="*{indirimKodu}">İndirim kodu hatası</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="toplamTutar" class="form-label">
                                        <i class="fas fa-money-bill-wave text-success"></i> Toplam Tutar (₺)
                                    </label>
                                    <input type="number" 
                                           class="form-control bg-light" 
                                           th:class="${#fields.hasErrors('toplamTutar')} ? 'form-control bg-light is-invalid' : 'form-control bg-light'"
                                           id="toplamTutar" 
                                           th:field="*{toplamTutar}" 
                                           placeholder="0.00"
                                           step="0.01"
                                           min="0"
                                           readonly>
                                    <div th:if="${#fields.hasErrors('toplamTutar')}" class="invalid-feedback">
                                        <span th:errors="*{toplamTutar}">Toplam tutar hatası</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-sticky-note"></i> Notlar
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="adminNotu" class="form-label">
                                    <i class="fas fa-user-shield text-warning"></i> Admin Notu
                                </label>
                                <textarea class="form-control" 
                                          th:class="${#fields.hasErrors('adminNotu')} ? 'form-control is-invalid' : 'form-control'"
                                          id="adminNotu" 
                                          th:field="*{adminNotu}" 
                                          rows="3" 
                                          placeholder="Admin için özel notlar..."></textarea>
                                <div th:if="${#fields.hasErrors('adminNotu')}" class="invalid-feedback">
                                    <span th:errors="*{adminNotu}">Admin notu hatası</span>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="musteriNotu" class="form-label">
                                    <i class="fas fa-user text-info"></i> Müşteri Notu
                                </label>
                                <textarea class="form-control bg-light" 
                                          id="musteriNotu" 
                                          th:field="*{musteriNotu}" 
                                          rows="2" 
                                          placeholder="Müşteri tarafından bırakılan not..."
                                          readonly></textarea>
                                <div class="form-text">Bu alan müşteri tarafından doldurulmuştur ve değiştirilemez.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <div>
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-save"></i> Güncelle
                            </button>
                            <a th:href="@{/admin/siparisler/{id}(id=${siparis.id})}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> İptal
                            </a>
                        </div>
                        
                        <div>
                            <button type="button" class="btn btn-danger" 
                                    th:onclick="'confirmCancel(' + ${siparis.id} + ', \'' + ${siparis.id} + '\')'"
                                    th:if="${siparis.durum != 'IPTAL_EDILDI' and siparis.durum != 'TESLIM_EDILDI'}">
                                <i class="fas fa-times"></i> Siparişi İptal Et
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Order Items -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-info">
                            <i class="fas fa-list"></i> Sipariş Kalemleri
                        </h6>
                    </div>
                    <div class="card-body">
                        <div th:each="kalem : ${siparis.siparisKalemleri}" class="d-flex align-items-center mb-3 pb-3 border-bottom">
                            <div class="me-3">
                                <div class="book-cover bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 55px; border-radius: 4px;">
                                    <i class="fas fa-book text-muted"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1" th:text="${kalem.kitap.ad}">Kitap Adı</h6>
                                <small class="text-muted" th:text="${kalem.kitap.yazar}">Yazar</small><br>
                                <small class="text-success fw-bold" th:text="${kalem.adet} + ' x ' + ${kalem.birimFiyat} + ' ₺'">1 x 50 ₺</small>
                            </div>
                            <div class="text-end">
                                <span class="fw-bold" th:text="${kalem.toplamFiyat} + ' ₺'">50 ₺</span>
                            </div>
                        </div>
                        
                        <div class="text-end">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Ara Toplam:</span>
                                <span th:text="${siparis.araToplam} + ' ₺'">0 ₺</span>
                            </div>
                            <div th:if="${siparis.kargoUcreti > 0}" class="d-flex justify-content-between mb-1">
                                <span>Kargo:</span>
                                <span th:text="${siparis.kargoUcreti} + ' ₺'">0 ₺</span>
                            </div>
                            <div th:if="${siparis.indirimTutari > 0}" class="d-flex justify-content-between mb-1">
                                <span>İndirim:</span>
                                <span class="text-danger" th:text="'-' + ${siparis.indirimTutari} + ' ₺'">-0 ₺</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold">Toplam:</span>
                                <span class="fw-bold text-success" th:text="${siparis.toplamTutar} + ' ₺'">0 ₺</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Customer Info -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-success">
                            <i class="fas fa-user"></i> Müşteri Bilgileri
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <div class="avatar avatar-lg mx-auto mb-2">
                                <div class="avatar-title bg-primary rounded-circle fs-4">
                                    <span th:text="${siparis.kullanici.ad.substring(0,1).toUpperCase()}">A</span>
                                </div>
                            </div>
                            <h6 class="mb-1" th:text="${siparis.kullanici.ad + ' ' + siparis.kullanici.soyad}">Ad Soyad</h6>
                            <p class="text-muted mb-0" th:text="${siparis.kullanici.email}">email@example.com</p>
                        </div>
                        
                        <div class="d-grid">
                            <a th:href="@{/admin/kullanicilar/{id}(id=${siparis.kullanici.id})}" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-user"></i> Müşteri Detayı
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-warning">
                            <i class="fas fa-bolt"></i> Hızlı İşlemler
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a th:href="@{/admin/siparisler/{id}(id=${siparis.id})}" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-eye"></i> Detayları Görüntüle
                            </a>
                            <a th:href="@{/admin/siparisler/{id}/invoice(id=${siparis.id})}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-file-invoice"></i> Fatura
                            </a>
                            <button type="button" class="btn btn-outline-success btn-sm" 
                                    th:onclick="'sendNotification(' + ${siparis.id} + ', \'' + ${siparis.kullanici.email} + '\')'"
                                    th:if="${siparis.durum != 'IPTAL_EDILDI'}">
                                <i class="fas fa-envelope"></i> Bildirim Gönder
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cancel Confirmation Modal -->
        <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cancelModalLabel">
                            <i class="fas fa-exclamation-triangle text-warning"></i> Sipariş İptal
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong id="cancelSiparisNo"></strong> numaralı siparişi iptal etmek istediğinizden emin misiniz?</p>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Uyarı:</strong> İptal edilen siparişler geri alınamaz.
                        </div>
                        <div class="mb-3">
                            <label for="iptalNedeni" class="form-label">İptal Nedeni</label>
                            <select class="form-select" id="iptalNedeni" name="iptalNedeni">
                                <option value="">Neden seçiniz</option>
                                <option value="Stok yetersizliği">Stok yetersizliği</option>
                                <option value="Ödeme problemi">Ödeme problemi</option>
                                <option value="Müşteri talebi">Müşteri talebi</option>
                                <option value="Teknik sorun">Teknik sorun</option>
                                <option value="Diğer">Diğer</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="iptalAciklama" class="form-label">Açıklama (İsteğe bağlı)</label>
                            <textarea class="form-control" id="iptalAciklama" name="iptalAciklama" rows="3" placeholder="İptal nedeni hakkında detay verebilirsiniz..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
                        <form id="cancelForm" method="post" style="display: inline;">
                            <input type="hidden" name="_method" value="patch">
                            <input type="hidden" name="durum" value="IPTAL_EDILDI">
                            <input type="hidden" name="iptalNedeni" id="hiddenIptalNedeni">
                            <input type="hidden" name="iptalAciklama" id="hiddenIptalAciklama">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-times"></i> İptal Et
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <style>
        .avatar {
            width: 40px;
            height: 40px;
        }
        
        .avatar-lg {
            width: 60px;
            height: 60px;
        }
        
        .avatar-title {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
    </style>
    
    <script>
        function calculateTotal() {
            const araToplam = parseFloat(document.getElementById('araToplam').value) || 0;
            const kargoUcreti = parseFloat(document.getElementById('kargoUcreti').value) || 0;
            const indirimTutari = parseFloat(document.getElementById('indirimTutari').value) || 0;
            
            const toplamTutar = araToplam + kargoUcreti - indirimTutari;
            document.getElementById('toplamTutar').value = toplamTutar.toFixed(2);
        }
        
        function confirmCancel(siparisId, siparisNo) {
            const cancelForm = document.getElementById('cancelForm');
            const cancelSiparisNo = document.getElementById('cancelSiparisNo');
            
            cancelForm.action = '/admin/siparisler/' + siparisId + '/status';
            cancelSiparisNo.textContent = '#' + siparisNo;
            
            const cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
            cancelModal.show();
        }
        
        // Update hidden fields when modal form is submitted
        document.getElementById('cancelForm').addEventListener('submit', function() {
            document.getElementById('hiddenIptalNedeni').value = document.getElementById('iptalNedeni').value;
            document.getElementById('hiddenIptalAciklama').value = document.getElementById('iptalAciklama').value;
        });
        
        function sendNotification(siparisId, email) {
            if (confirm(`${email} adresine sipariş durumu bildirimi göndermek istediğinizden emin misiniz?`)) {
                fetch(`/admin/siparisler/${siparisId}/notify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Bildirim başarıyla gönderildi.');
                    } else {
                        alert('Bildirim gönderilirken hata oluştu.');
                    }
                })
                .catch(error => {
                    alert('Bildirim gönderilirken hata oluştu.');
                });
            }
        }
        
        // Form validation
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();
    </script>
</body>
</html>